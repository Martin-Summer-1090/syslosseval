---
title: "Pictures and Statistics in the Appendix"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{appendix_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(syslosseval)
library(tidyverse)
```

# The gap between total assets and total eba exposures

## 2016

```{r}
total_assets_2016 <- eba_exposures_2016 %>%
    filter(Exposure == "Total assets") %>%
    select(LEI_code, Bank_name, Total_Amount)

total_assets_eba_2016 <- eba_exposures_2016 %>%
    filter(!(Exposure %in% c("Common tier1 equity capital", "Total assets")), Country == "Total") %>%
    group_by(LEI_code, Bank_name) %>%
    summarize(Total_Amount_EBA = sum(Total_Amount, na.rm = F))

asset_sum_compare_2016 <- left_join(total_assets_2016, total_assets_eba_2016, by = c("LEI_code", "Bank_name")) %>%
    arrange(Bank_name) %>% 
    mutate(abs_diff = Total_Amount_EBA - Total_Amount) %>% 
    mutate(rel_diff = abs_diff/Total_Amount) %>% 
    mutate(hi_lo = if_else(rel_diff > 0, "Above", "Below")) 
```

```{r}
p_2016 <- ggplot(data = asset_sum_compare_2016,
              mapping = aes(x = Bank_name, y = rel_diff, fill = hi_lo))
  
  gaps_2016 <- p_2016 + geom_col() + guides(fill = FALSE) +
          labs(x = NULL, y = "Difference in percent",
          title = "Value gaps",
          subtitle = "Residual Position") +
          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
          coord_flip()
  
  ggsave(filename = "../paper/Figures/gaps_2016.png", plot = gaps_2016)
```
```{r}



hist_residual_2016 <- ggplot(data = asset_sum_compare_2016, mapping= aes(rel_diff)) + 
  geom_histogram(bins=15, color = "black", fill = "white", boundary = 0)  + 
  labs(x = "Percentage value gap", y = "Number of Banks") +
  geom_vline(xintercept = -0.084115 , color = "red", linetype = "dashed") 
  
 ggsave(filename = "../paper/Figures/hist_residual_2016.png", plot = hist_residual_2016)
```

## 2020

```{r}
total_assets_2020 <- eba_exposures_2020 %>%
    filter(Exposure == "Total assets") %>%
    select(LEI_code, Bank_name, Total_Amount)

total_assets_eba_2020 <- eba_exposures_2020 %>%
    filter(!(Exposure %in% c("Common tier1 equity capital", "Total assets")), Country == "Total") %>%
    group_by(LEI_code, Bank_name) %>%
    summarize(Total_Amount_EBA = sum(Total_Amount, na.rm = F))

asset_sum_compare_2020 <- left_join(total_assets_2020, total_assets_eba_2020, by = c("LEI_code", "Bank_name")) %>%
    arrange(Bank_name) %>% 
    mutate(abs_diff = Total_Amount_EBA - Total_Amount) %>% 
    mutate(rel_diff = abs_diff/Total_Amount) %>% 
    mutate(hi_lo = if_else(rel_diff > 0, "Above", "Below")) 
```



